Vagrant.configure("2") do |config|
  config.vm.box = "ubuntu/focal64"

  # Web Server
  config.vm.define "web" do |web|
    web.vm.hostname = "web-server"
    web.vm.network "private_network", ip: "192.168.56.10"
    web.vm.provision "shell", inline: <<-SHELL
      sudo apt-get update
      sudo apt-get install -y nginx php-fpm php-mysql
      echo "<?php phpinfo(); ?>" | sudo tee /var/www/html/index.php
      sudo systemctl restart nginx
    SHELL
  end



  # Database Server
  config.vm.define "db" do |db|
    db.vm.hostname = "db-server"
    db.vm.network "private_network", ip: "192.168.56.11"
    db.vm.provision "shell", inline: <<-SHELL
      sudo apt-get update
      sudo apt-get install -y mysql-server
      sudo mysql -e "CREATE DATABASE myapp;"
      sudo mysql -e "CREATE USER 'appuser'@'%' IDENTIFIED BY 'password';"
      sudo mysql -e "GRANT ALL PRIVILEGES ON myapp.* TO 'appuser'@'%';"
      sudo sed -i "s/bind-address.*/bind-address = 0.0.0.0/" /etc/mysql/mysql.conf.d/mysqld.cnf
      sudo systemctl restart mysql
    SHELL
  end
end
